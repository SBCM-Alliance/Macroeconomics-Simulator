<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBCM Simulator: G-Scale vs G-Cart</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.05.1/pyscript.css" />
    <script defer src="https://pyscript.net/releases/2023.05.1/pyscript.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-scale: #e74c3c; /* G-Scale èµ¤ */
            --accent-cart: #2ecc71; /* G-Cart ç·‘ */
            --bg-color: #f4f6f7;
        }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: var(--bg-color); color: #333; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--primary-color); }
        .subtitle { text-align: center; color: #7f8c8d; font-size: 0.9em; margin-bottom: 30px; }
        
        .controls { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; align-items: center; justify-content: center; background: #ecf0f1; padding: 20px; border-radius: 8px; }
        .mode-switch { display: flex; gap: 20px; }
        .radio-label { cursor: pointer; font-weight: bold; padding: 10px 20px; border-radius: 20px; transition: 0.3s; border: 2px solid transparent; background: #fff; }
        
        /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        input[type="radio"] { display: none; }
        input[type="radio"]#mode_scale:checked + label { background-color: var(--accent-scale); color: white; border-color: var(--accent-scale); }
        input[type="radio"]#mode_cart:checked + label { background-color: var(--accent-cart); color: white; border-color: var(--accent-cart); }
        
        .budget-control { width: 100%; text-align: center; }
        input[type="range"] { width: 80%; }

        /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { padding: 20px; border-radius: 8px; background: #fff; border: 1px solid #ddd; }
        .metric-title { font-size: 0.9em; color: #7f8c8d; }
        .metric-value { font-size: 1.8em; font-weight: bold; margin: 10px 0; }
        
        /* ãƒãƒ¼ã‚°ãƒ©ãƒ• */
        .bar-container { height: 30px; background: #eee; border-radius: 15px; overflow: hidden; margin-top: 10px; position: relative; }
        .bar-fill { height: 100%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8em; font-weight: bold; }
        
        /* ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›é¢¨ */
        .log-window { background: #2c3e50; color: #2ecc71; font-family: monospace; padding: 15px; border-radius: 8px; height: 150px; overflow-y: auto; margin-top: 20px; font-size: 0.9em; }

        /* G-Scaleæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .scale-mode .metric-value { color: var(--accent-scale); }
        .scale-mode .bar-fill { background: var(--accent-scale); }
        
        /* G-Cartæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .cart-mode .metric-value { color: var(--accent-cart); }
        .cart-mode .bar-fill { background: var(--accent-cart); }

        .btn-run { padding: 10px 20px; cursor: pointer; border-radius: 5px; border: none; background: #34495e; color: white; font-weight: bold; }
        .btn-run:hover { opacity: 0.9; }

        @media (max-width: 600px) {
            .results-grid { grid-template-columns: 1fr; }
            .mode-switch { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ›ï¸ Public Works Simulator</h1>
    <p class="subtitle">Mainstream Economics vs. SBCM Theory</p>

    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
    <div class="controls">
        <div class="budget-control">
            <label>äºˆç®—è¦æ¨¡ (Budget): <span id="budget_display">10å„„å††</span></label><br>
            <input type="range" id="budget_slider" min="1" max="100" value="10" step="1">
        </div>
        <div class="mode-switch">
            <input type="radio" id="mode_scale" name="mode" value="scale" checked>
            <label for="mode_scale" class="radio-label">ğŸ”´ G-Scale (çµŒæ¸ˆå­¦ã®å®šèª¬)</label>

            <input type="radio" id="mode_cart" name="mode" value="cart">
            <label for="mode_cart" class="radio-label">ğŸŸ¢ G-Cart (SBCMç†è«–)</label>
        </div>
        <button id="run_btn" class="btn-run" py-click="run_simulation()">å®Ÿè¡Œ (Run)</button>
    </div>

    <!-- çµæœè¡¨ç¤º -->
    <div id="dashboard" class="scale-mode">
        <div class="results-grid">
            <!-- å·¦å´ï¼šãŠé‡‘ã®æµã‚Œ -->
            <div class="card">
                <div class="metric-title">Flow of Wealth (å¯Œã®æµå‡ºå…ˆ)</div>
                
                <p>ğŸ¢ æ±äº¬ (Central): <span id="tokyo_share">0</span>%</p>
                <div class="bar-container">
                    <div id="bar_tokyo" class="bar-fill" style="width: 0%; background: #e74c3c;"></div>
                </div>

                <p style="margin-top:20px;">ğŸ¡ åœ°æ–¹ (Local): <span id="local_share">0</span>%</p>
                <div class="bar-container">
                    <div id="bar_local" class="bar-fill" style="width: 0%; background: #2ecc71;"></div>
                </div>
            </div>

            <!-- å³å´ï¼šåœ°åŸŸã®ç”Ÿå­˜ç‡ -->
            <div class="card">
                <div class="metric-title">Local Survival Rate (åœ°åŸŸç”Ÿå­˜ç‡)</div>
                <div id="survival_rate" class="metric-value">0%</div>
                <p id="survival_desc" style="font-size: 0.9em;">-</p>
                <hr>
                <div class="metric-title">Admin Cost (è¡Œæ”¿ã‚³ã‚¹ãƒˆ)</div>
                <div id="admin_cost" class="metric-value">Â¥0</div>
            </div>
        </div>

        <!-- ãƒ­ã‚°å‡ºåŠ› -->
        <div class="log-window" id="log_output">
            System Ready...<br>
            Select a mode and click 'Run'.
        </div>
    </div>
</div>

<!-- Pythonãƒ­ã‚¸ãƒƒã‚¯ -->
<py-script>
import js
from pyodide.ffi import create_proxy

# å®šæ•°å®šç¾©
LOCAL_CAPACITY_LIMIT = 5 # åœ°æ–¹ä¼æ¥­ã®å˜ç‹¬å—æ³¨é™ç•Œ (å„„å††)
ADMIN_COST_MANUAL = 0.20 # æ‰‹å‹•ç®¡ç†ã‚³ã‚¹ãƒˆ (20%)
ADMIN_COST_ALGO = 0.01   # ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ç®¡ç†ã‚³ã‚¹ãƒˆ (1%)

def run_simulation(*args):
    # 1. å…¥åŠ›å€¤ã®å–å¾—
    budget_oku_str = js.document.getElementById('budget_slider').value
    budget_oku = int(budget_oku_str)
    budget = budget_oku * 100000000 # å††æ›ç®—
    
    # ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®çŠ¶æ…‹å–å¾—
    mode_scale = js.document.getElementById('mode_scale').checked
    mode = "G-Scale" if mode_scale else "G-Cart"

    # UIã®ãƒªã‚»ãƒƒãƒˆã¨ãƒ¢ãƒ¼ãƒ‰åæ˜ 
    dashboard = js.document.getElementById('dashboard')
    if mode_scale:
        dashboard.classList.remove("cart-mode")
        dashboard.classList.add("scale-mode")
    else:
        dashboard.classList.remove("scale-mode")
        dashboard.classList.add("cart-mode")
    
    logs = []
    logs.append(f"ğŸš€ Simulation Started: {mode}")
    logs.append(f"ğŸ’° Project Budget: {budget:,}å††")

    # ==========================================
    # ğŸ”´ G-Scale Logic (Mainstream Economics)
    # ==========================================
    if mode == "G-Scale":
        logs.append("--- Logic: Efficiency & Scale ---")
        logs.append("â„¹ï¸ Policy: 'Bundling small projects for efficiency.'")
        
        # 1. ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆåŒ…æ‹¬ç™ºæ³¨ï¼‰
        # äºˆç®—ãŒå¤§ãã‘ã‚Œã°å¤§ãã„ã»ã©ã€å˜ä¸€ã®å·¨å¤§å¥‘ç´„ã«ã™ã‚‹
        contract_size = budget 
        logs.append(f"ğŸ“¦ Bundled into 1 contract: {contract_size:,}å††")

        # 2. å—æ³¨åˆ¤å®š (ã‚­ãƒ£ãƒ‘ä¸è¶³ã®åœ°æ–¹ã¯æ’é™¤)
        # 5å„„å††ã‚’è¶…ãˆã‚‹ã¨åœ°æ–¹ä¼æ¥­ã¯å—æ³¨ä¸èƒ½ã«ãªã‚‹è¨­å®š
        if contract_size > (LOCAL_CAPACITY_LIMIT * 100000000):
            winner = "Tokyo General Contractor"
            leakage_rate = 1.0 # 100%æ¼å‡º
            logs.append(f"âš ï¸ Local Capacity Exceeded ({LOCAL_CAPACITY_LIMIT}å„„ < {budget_oku}å„„)")
            logs.append(f"ğŸ† Winner: {winner} (Capital > 100å„„)")
            local_survival = 0
            survival_text = "ğŸ’€ å£Šæ»… (å—æ³¨ã‚¼ãƒ­)"
        else:
            winner = "Local SME"
            leakage_rate = 0.1 # è³‡æè²»ãªã©ã¯æ¼ã‚Œã‚‹
            local_survival = 100
            survival_text = "ğŸ˜Š ç”Ÿå­˜ (å—æ³¨å¯èƒ½)"

        # 3. è¡Œæ”¿ã‚³ã‚¹ãƒˆ
        admin_cost = int(budget * ADMIN_COST_MANUAL) 
        logs.append(f"ğŸ’¸ Admin/Margin Cost: {admin_cost:,}å†† (20%)")

    # ==========================================
    # ğŸŸ¢ G-Cart Logic (SBCM Theory)
    # ==========================================
    else:
        logs.append("--- Logic: Mesh Refinement & Retention ---")
        logs.append("â„¹ï¸ Policy: 'Splitting budget to fit local capacity.'")

        # 1. ãƒ¡ãƒƒã‚·ãƒ¥ç´°åˆ†åŒ– (Mesh Refinement)
        # åœ°æ–¹ä¼æ¥­ã®ã‚­ãƒ£ãƒ‘(5å„„å††)ã«åˆã‚ã›ã¦åˆ†å‰²ç™ºæ³¨
        # å®‰å…¨ç‡0.8ã‚’ã‹ã‘ã¦ã€4å„„å††å˜ä½ãã‚‰ã„ã§åˆ†å‰²ã™ã‚‹
        split_unit = LOCAL_CAPACITY_LIMIT * 100000000 * 0.8
        num_contracts = int(budget / split_unit)
        if num_contracts < 1:
            num_contracts = 1
            
        unit_price = int(budget / num_contracts)
        
        logs.append(f"âœ‚ï¸ Mesh Refinement: Split into {num_contracts} contracts")
        logs.append(f"ğŸ“‰ Unit Price: {unit_price:,}å††")

        # 2. å—æ³¨åˆ¤å®š
        # åˆ†å‰²ã—ãŸã®ã§åœ°æ–¹ä¼æ¥­ãŒå—æ³¨å¯èƒ½
        winner = "Local SME Alliance"
        leakage_rate = 0.05 # æœ€å°é™ã®æ¼å‡º
        local_survival = 100
        survival_text = "ğŸ‰ ç¹æ „ (å…¨ç¤¾å—æ³¨ãƒ»å¾ªç’°)"
        
        logs.append(f"âœ… Capacity Check: OK ({unit_price} < Limit)")
        logs.append(f"ğŸ¤ Formed {num_contracts} Virtual JVs")

        # 3. è¡Œæ”¿ã‚³ã‚¹ãƒˆ
        admin_cost = int(budget * ADMIN_COST_ALGO)
        logs.append(f"âš¡ Algo Cost: {admin_cost:,}å†† (1%)")

    # ==========================================
    # ğŸ“Š çµæœã®è¨ˆç®—ã¨æç”»
    # ==========================================
    
    # æ±äº¬ã¸ã®æµå‡ºé¡ (Leakage)
    tokyo_amount = int(budget * leakage_rate)
    local_amount = budget - tokyo_amount
    
    tokyo_percent = int(leakage_rate * 100)
    local_percent = 100 - tokyo_percent

    # DOMæ›´æ–°
    js.document.getElementById('tokyo_share').innerText = str(tokyo_percent)
    js.document.getElementById('bar_tokyo').style.width = f"{tokyo_percent}%"
    
    tokyo_text = f"{tokyo_amount:,}å††" if tokyo_percent > 15 else ""
    js.document.getElementById('bar_tokyo').innerText = tokyo_text

    js.document.getElementById('local_share').innerText = str(local_percent)
    js.document.getElementById('bar_local').style.width = f"{local_percent}%"
    
    local_text = f"{local_amount:,}å††" if local_percent > 15 else ""
    js.document.getElementById('bar_local').innerText = local_text

    js.document.getElementById('survival_rate').innerText = f"{local_survival}%"
    js.document.getElementById('survival_desc').innerText = survival_text
    js.document.getElementById('admin_cost').innerText = f"{admin_cost:,}å††"

    # ãƒ­ã‚°è¡¨ç¤ºæ›´æ–°
    log_html = "<br>".join(logs)
    js.document.getElementById('log_output').innerHTML = log_html

# ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
def on_slider_change(event):
    val = event.target.value
    js.document.getElementById('budget_display').innerText = f"{val}å„„å††"

slider_proxy = create_proxy(on_slider_change)
js.document.getElementById('budget_slider').addEventListener("input", slider_proxy)

# åˆå›å®Ÿè¡Œ
run_simulation()
</py-script>

</body>
</html>